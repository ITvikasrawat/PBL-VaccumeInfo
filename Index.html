<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PBL VacuumOps | Teal Edition</title>
    
    <!-- âœ… Favicon (Logo) -->
    <link rel="icon" type="image/png" href="pbl-logo.png">
    
    <!-- ==============================================
         LIBRARIES (DEPENDENCIES)
         Tailwind: Styling ke liye
         FontAwesome: Icons ke liye
         AlpineJS: Logic aur Interactivity ke liye
    =============================================== -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <!-- Tailwind Configuration (Custom Colors) -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Aapka naya Teal Color (#008080)
                        teal_primary: '#008080', 
                        teal_dark: '#006666',
                        dark_bg: '#0f172a'
                    },
                    fontFamily: { 
                        sans: ['Outfit', 'sans-serif'], 
                        mono: ['JetBrains Mono', 'monospace'] 
                    },
                    animation: {
                        'float': 'float 4s ease-in-out infinite',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards', // Smooth entry animation
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' },
                        },
                        slideUp: {
                            'from': { opacity: 0, transform: 'translateY(20px)' },
                            'to': { opacity: 1, transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* AlpineJS load hone se pehle content chipa rahe */
        [x-cloak] { display: none !important; }
        
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* ðŸ”¥ TEAL GRADIENT (Updated Theme) */
        .bg-gradient-teal { 
            background: linear-gradient(135deg, #008080 0%, #004d4d 100%); 
        }

        /* Glass Card Effect (Transparent Blur) */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 40px -10px rgba(0,128,128,0.15); /* Teal Shadow */
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.90);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }
        .glass-card:active { transform: scale(0.98); }

        /* Custom Input Fields */
        .input-box {
            width: 100%; padding: 16px; background: #f1f5f9; border: 2px solid transparent;
            border-radius: 16px; font-size: 0.95rem; color: #334155; outline: none; transition: 0.2s; font-weight: 700;
        }
        .dark .input-box { background: #0f172a; color: white; }
        .input-box:focus { background: white; border-color: #008080; box-shadow: 0 4px 12px rgba(0,128,128,0.1); }
        .dark .input-box:focus { background: #1e293b; border-color: #008080; }

        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>

<!-- Body Start -->
<body class="text-slate-800 transition-colors duration-300 min-h-screen pb-40 font-sans bg-slate-50 dark:bg-[#0b1120] dark:text-slate-200" x-data="vacuumTracker()">

    <!-- ==============================================
         HEADER SECTION (TEAL THEME)
    =============================================== -->
    <header class="relative pt-10 pb-28 px-6 overflow-hidden rounded-b-[3rem] shadow-2xl transition-colors duration-500 ease-out bg-gradient-teal">
        
        <!-- Background Decor (Circles & Icons) -->
        <div class="absolute inset-0 z-0">
            <div class="absolute bottom-0 right-0 w-full flex items-end justify-end text-white opacity-10 pr-6 pointer-events-none">
                <i class="fa-solid fa-fan text-[9rem] translate-x-4 translate-y-4"></i>
            </div>
            <div class="absolute top-[-40px] left-[-40px] w-64 h-64 bg-white/10 rounded-full blur-3xl animate-float"></div>
        </div>

        <div class="relative z-10">
            <!-- Top Navigation Bar -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <!-- Logo Box -->
                    <div class="w-14 h-14 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center shadow-lg border border-white/20 active:scale-95 transition-transform" @click="haptic()">
                        <img src="pbl-logo.png" alt="Logo" class="w-8 h-8 object-contain">
                    </div>
                    
                    <!-- Title & User Name -->
                    <div>
                        <h1 class="text-3xl font-black text-white leading-none tracking-tight">Vacuum<span class="opacity-80">Ops</span></h1>
                        <div class="flex items-center gap-2 mt-1.5 opacity-90">
                            <!-- Ashok Singh Badge -->
                            <span class="text-[10px] bg-white/20 backdrop-blur-md px-2 py-0.5 rounded text-white font-bold border border-white/10 uppercase">
                                <i class="fa-solid fa-user-shield mr-1"></i> Ashok Singh
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Dark Mode Toggle Button -->
                <button @click="toggleTheme()" class="w-10 h-10 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center text-white border border-white/10 active:scale-95 transition hover:bg-white/20">
                    <i class="fa-solid" :class="isDark ? 'fa-sun' : 'fa-moon'"></i>
                </button>
            </div>

            <!-- Search Bar -->
            <div class="relative group z-20">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="fa-solid fa-magnifying-glass text-white/60 group-focus-within:text-white transition-colors"></i>
                </div>
                <input type="text" x-model="search" placeholder="Search System Name or Asset ID..." 
                       class="block w-full pl-11 pr-4 py-4 bg-white/10 backdrop-blur-md border border-white/10 rounded-2xl text-sm font-bold text-white placeholder-white/50 focus:outline-none focus:bg-white/20 focus:ring-1 focus:ring-white/30 transition shadow-lg">
            </div>
        </div>
    </header>

    <!-- ==============================================
         MAIN CONTENT AREA
    =============================================== -->
    <main class="px-5 -mt-20 relative z-20 max-w-lg mx-auto space-y-5">

        <!-- 1. HUD SCORE CARD (Circular Progress) -->
        <div class="glass-card p-6 rounded-[2.5rem] flex justify-between items-center shadow-xl active:scale-98 transition-transform cursor-pointer" @click="haptic()">
            <div class="flex-1">
                <p class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Cycle Completion</p>
                <div class="flex items-baseline gap-1">
                    <h2 class="text-6xl font-black text-slate-800 dark:text-white tracking-tighter" x-text="percentage">0</h2>
                    <span class="text-2xl font-bold text-slate-400">%</span>
                </div>
            </div>
            <!-- Circle Chart SVG -->
            <div class="relative w-20 h-20">
                <svg class="w-full h-full transform -rotate-90 drop-shadow-lg">
                    <circle cx="40" cy="40" r="36" stroke="#e2e8f0" stroke-width="6" fill="transparent" class="dark:stroke-slate-700"/>
                    <circle cx="40" cy="40" r="36" stroke="currentColor" stroke-width="6" fill="transparent" 
                            :class="percentage == 100 ? 'text-teal_primary' : 'text-slate-400'"
                            :stroke-dasharray="226" :stroke-dashoffset="226 - (226 * percentage) / 100" class="transition-all duration-1000 ease-out" stroke-linecap="round"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center text-2xl text-slate-300 dark:text-slate-600">
                    <i class="fa-solid" :class="percentage == 100 ? 'fa-check text-teal_primary' : 'fa-chart-pie'"></i>
                </div>
            </div>
        </div>

        <!-- 2. FILTER TABS (Done / Pending) -->
        <div class="grid grid-cols-2 gap-3">
            <button @click="toggleFilter('DONE')" 
                    class="glass-card p-4 rounded-3xl flex items-center gap-3 active:scale-95 transition-all"
                    :class="filterStatus === 'DONE' ? 'ring-2 ring-teal_primary bg-teal-50 dark:bg-teal_primary/20' : ''">
                <div class="w-10 h-10 rounded-full flex items-center justify-center bg-teal-100 text-teal_primary dark:bg-teal_primary dark:text-white">
                    <i class="fa-solid fa-check"></i>
                </div>
                <div class="text-left">
                    <p class="text-[10px] uppercase font-bold text-slate-400">Done</p>
                    <p class="text-xl font-black text-slate-800 dark:text-white" x-text="doneCount">0</p>
                </div>
            </button>
            <button @click="toggleFilter('PENDING')" 
                    class="glass-card p-4 rounded-3xl flex items-center gap-3 active:scale-95 transition-all"
                    :class="filterStatus === 'PENDING' ? 'ring-2 ring-amber-500 bg-amber-50 dark:bg-amber-900/20' : ''">
                <div class="w-10 h-10 rounded-full flex items-center justify-center bg-amber-100 text-amber-600 dark:bg-amber-500 dark:text-white">
                    <i class="fa-regular fa-clock"></i>
                </div>
                <div class="text-left">
                    <p class="text-[10px] uppercase font-bold text-slate-400">Pending</p>
                    <p class="text-xl font-black text-slate-800 dark:text-white" x-text="pendingCount">0</p>
                </div>
            </button>
        </div>

        <!-- 3. LOADING INDICATOR (Teal Color) -->
        <div x-show="loading" class="py-12 text-center">
            <div class="w-12 h-12 border-4 border-slate-200 border-t-teal_primary rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest animate-pulse">Syncing Database...</p>
        </div>

        <!-- 4. ASSET LIST (Cards) -->
        <div class="space-y-3 pb-20">
            <template x-for="(pc, index) in filteredList" :key="pc.systemName + index">
                <div class="glass-card p-5 rounded-[1.5rem] relative overflow-hidden group animate-slide-up"
                     :style="`animation-delay: ${index * 50}ms`"
                     :class="pc.status === 'DONE' ? 'border-l-[6px] border-l-teal_primary' : 'border-l-[6px] border-l-amber-500'"
                     @click="openModal('edit', pc)">
                    
                    <div class="flex justify-between items-start relative z-10">
                        <div class="flex gap-4">
                            <!-- Icon Box -->
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-lg transition-colors"
                                 :class="pc.status === 'DONE' ? 'bg-teal-100 text-teal_primary dark:bg-teal_primary dark:text-white' : 'bg-amber-100 text-amber-600 dark:bg-amber-500 dark:text-white'">
                                <i class="fa-solid" :class="pc.status === 'DONE' ? 'fa-check' : 'fa-broom'"></i>
                            </div>

                            <div>
                                <!-- System Name -->
                                <h3 class="font-black text-lg text-slate-800 dark:text-white leading-tight" x-text="pc.systemName"></h3>
                                
                                <!-- Asset ID Badge (With Barcode Icon) -->
                                <div class="mt-1.5 inline-flex items-center px-2.5 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                                    <i class="fa-solid fa-barcode text-[10px] text-slate-400 mr-1.5"></i>
                                    <span class="text-[11px] font-mono font-bold text-slate-600 dark:text-slate-300 tracking-wide" x-text="pc.assetId ? pc.assetId : 'No ID'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Date/Status -->
                        <div class="text-right">
                            <template x-if="pc.status === 'DONE'">
                                <div>
                                    <span class="text-[9px] font-black text-teal_primary dark:text-teal-300 uppercase bg-teal-50 dark:bg-teal_primary/30 px-2 py-0.5 rounded">CLEAN</span>
                                    <p class="text-[10px] font-bold text-slate-400 mt-1" x-text="formatDateDisplay(pc.date)"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Footer: OS & Action -->
                    <div class="flex justify-between items-center mt-4 pt-3 border-t border-slate-100 dark:border-white/5">
                        <div class="flex items-center gap-2 text-slate-400">
                            <i :class="getOsIcon(pc.os)"></i>
                            <span class="text-[10px] font-bold uppercase tracking-wide" x-text="pc.os"></span>
                        </div>
                        <div class="text-[11px] font-bold text-teal_primary flex items-center gap-1 group-active:translate-x-1 transition-transform">
                            Edit <i class="fa-solid fa-chevron-right text-[9px]"></i>
                        </div>
                    </div>

                    <!-- Updating Overlay -->
                    <div x-show="pc.updating" class="absolute inset-0 bg-white/80 dark:bg-black/60 backdrop-blur-sm z-20 flex items-center justify-center">
                        <i class="fa-solid fa-circle-notch fa-spin text-teal_primary text-2xl"></i>
                    </div>
                </div>
            </template>

            <!-- Empty State -->
            <div x-show="filteredList.length === 0 && !loading" class="text-center py-12 opacity-50">
                <i class="fa-solid fa-box-open text-4xl text-slate-300 mb-2"></i>
                <p class="text-sm font-bold text-slate-400">No assets found</p>
                <button @click="filterStatus = 'ALL'; search = ''" x-show="filterStatus !== 'ALL' || search" class="mt-4 text-xs font-bold text-teal_primary underline">Reset Filters</button>
            </div>
        </div>
    </main>

    <!-- FLOATING ACTION BUTTON (TEAL) -->
    <button @click="openModal('add')" class="fixed bottom-24 right-5 w-14 h-14 bg-gradient-to-br from-teal_primary to-teal_dark rounded-full text-white shadow-2xl shadow-teal_primary/40 flex items-center justify-center active:scale-90 transition-transform z-40">
        <i class="fa-solid fa-plus text-xl"></i>
    </button>

    <!-- ==============================================
         FOOTER SECTION
    =============================================== -->
    <footer class="fixed bottom-0 left-0 w-full bg-white/90 dark:bg-[#0f172a]/95 backdrop-blur-xl border-t border-slate-200 dark:border-white/5 p-4 z-50 flex justify-between items-center pb-6">
        <div>
            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Logged in as</p>
            <p class="text-sm font-black text-slate-800 dark:text-white">Ashok Singh <span class="text-[9px] bg-teal-100 text-teal_primary px-1.5 py-0.5 rounded ml-1">IT</span></p>
        </div>
        <div class="flex gap-2">
            <button @click="fetchData(true)" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-white/10 flex items-center justify-center text-slate-500 dark:text-slate-300 active:scale-95 transition">
                <i class="fa-solid fa-rotate" :class="{'fa-spin': isSyncing}"></i>
            </button>
            <button @click="openConfirmModal()" class="px-4 h-10 rounded-xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold text-xs flex items-center gap-2 shadow-lg active:scale-95 transition" :disabled="emailSending">
                <i class="fa-regular fa-paper-plane"></i> Report
            </button>
        </div>
    </footer>

    <!-- ==============================================
         MODALS
    =============================================== -->

    <!-- Add/Edit Modal -->
    <div x-show="showModal" x-cloak 
         class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-md p-0 sm:p-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-full"
         x-transition:enter-end="opacity-100 translate-y-0">
        
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 shadow-2xl relative" @click.away="showModal = false">
            <div class="absolute top-3 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full sm:hidden"></div>
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800 dark:text-white" x-text="mode === 'add' ? 'Add Asset' : 'Edit Asset'"></h3>
                <button @click="showModal = false" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-white/10 text-slate-500 flex items-center justify-center hover:bg-rose-100 hover:text-rose-500 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="space-y-4">
                <!-- System Name Input -->
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 block">System Name</label>
                    <div class="relative">
                        <i class="fa-solid fa-desktop absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" x-model="form.systemName" class="input-box pl-10 uppercase" placeholder="PBLNET001">
                    </div>
                </div>

                <!-- Asset ID Input -->
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 block">Asset Tag / ID</label>
                    <div class="relative">
                        <i class="fa-solid fa-barcode absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" x-model="form.assetId" class="input-box pl-10 font-mono text-sm" placeholder="e.g. PBL-NOD-IT-CPU-001">
                    </div>
                </div>

                <!-- OS Select -->
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 block">Operating System</label>
                    <div class="relative">
                        <select x-model="form.os" class="input-box appearance-none">
                            <option value="Windows 11 Pro">Windows 11 Pro</option>
                            <option value="Windows 10">Windows 10</option>
                            <option value="Windows XP">Windows XP</option>
                            <option value="Windows Server 2019">Windows Server 2019</option>
                            <option value="Windows Server 2003">Windows Server 2003</option>
                            <option value="OpenSuse">OpenSuse Linux</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>

                <!-- Status & Date Inputs -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 block">Current Status</label>
                        <div class="relative">
                            <select x-model="form.status" @change="handleStatusChange()" class="input-box appearance-none"
                                    :class="form.status === 'DONE' ? 'text-teal_primary bg-teal-50' : 'text-amber-600 bg-amber-50'">
                                <option value="PENDING">Pending</option>
                                <option value="DONE">Cleaned</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 block">Cleaning Date</label>
                        <input type="date" x-model="form.date" class="input-box" :disabled="form.status !== 'DONE'">
                    </div>
                </div>

                <!-- Admin Key Input -->
                <div class="pt-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 block">Admin Passkey</label>
                    <input type="password" x-model="form.secret" placeholder="Enter Key..." class="input-box border-2 border-dashed focus:border-solid">
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 pt-4 mt-2">
                    <button x-show="mode === 'edit'" @click="performAction('delete')" class="w-14 h-14 rounded-2xl bg-rose-50 text-rose-500 flex items-center justify-center text-xl hover:bg-rose-100 transition"><i class="fa-solid fa-trash"></i></button>
                    <button @click="performAction('save')" class="flex-1 h-14 rounded-2xl bg-slate-900 dark:bg-teal_primary text-white font-bold text-sm shadow-xl flex items-center justify-center gap-2 active:scale-95 transition">
                        <span x-text="submitting ? 'Saving...' : 'Save Changes'"></span>
                        <i x-show="!submitting" class="fa-solid fa-check"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div x-show="showConfirmModal" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center bg-black/70 backdrop-blur-md p-6">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-xs rounded-[2rem] p-8 text-center shadow-2xl">
            <div class="w-16 h-16 bg-teal-50 dark:bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4 text-teal_primary dark:text-teal-400 text-2xl"><i class="fa-solid fa-paper-plane"></i></div>
            <h3 class="text-xl font-black text-slate-800 dark:text-white mb-2">Send Report?</h3>
            <p class="text-xs text-slate-500 mb-6">Send status summary to IT Head.</p>
            <div class="flex gap-3">
                <button @click="showConfirmModal = false" class="flex-1 py-3 bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-slate-300 rounded-xl font-bold text-xs">Cancel</button>
                <button @click="sendEmailReport(); showConfirmModal = false" class="flex-1 py-3 bg-teal_primary text-white rounded-xl font-bold text-xs shadow-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div x-show="showReportModal" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-md p-6">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-sm rounded-[2rem] p-8 text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-teal-400 to-emerald-500"></div>
            <div class="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl animate-bounce">ðŸŽ‰</div>
            <h3 class="text-2xl font-black text-slate-800 dark:text-white mb-2">Cycle Complete!</h3>
            <p class="text-sm text-slate-500 mb-6">All systems are clean. Good job, Ashok!</p>
            <button @click="sendEmailReport()" class="w-full py-4 bg-teal_primary text-white rounded-xl font-bold text-sm shadow-teal_primary/30 shadow-lg">Send Closure Report</button>
            <button @click="showReportModal = false" class="mt-4 text-xs font-bold text-slate-400">Dismiss</button>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-[120] transition-all duration-300 opacity-0 pointer-events-none transform -translate-y-10">
        <i class="fa-solid fa-check-circle text-teal-400"></i>
        <span id="toast-msg" class="text-xs font-bold">Success</span>
    </div>

    <!-- ==============================================
         JAVASCRIPT LOGIC (ALPINE.JS)
    =============================================== -->
    <script>
        // âœ… YOUR NEW API URL
        const API_URL = "https://script.google.com/macros/s/AKfycbzcC-725iqJopRom9r_vGd5bZ2WKxTS0ZKDTWkflUZXluqzPWSkok1PPzyosA7QJ7G4Og/exec";  

        // Toast Helper: Message dikhane ke liye
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.innerText = msg;
            toast.querySelector('i').className = isError ? 'fa-solid fa-circle-exclamation text-rose-400' : 'fa-solid fa-check-circle text-teal-400';
            toast.classList.remove('opacity-0', '-translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 3000);
        }

        // Haptic Feedback: Phone vibration ke liye
        function vibrateDevice(pattern = [50]) {
            if ("vibrate" in navigator) navigator.vibrate(pattern);
        }

        // Main Logic
        document.addEventListener('alpine:init', () => {
            Alpine.data('vacuumTracker', () => ({
                pcs: [], search: '', loading: false, isSyncing: false, submitting: false, showModal: false, showReportModal: false, showConfirmModal: false, emailSending: false, isDark: false, mode: 'add', filterStatus: 'ALL',
                form: { systemName: '', assetId: '', os: 'Windows 11 Pro', status: 'PENDING', date: '', secret: '' },

                // App Initialize hone par yeh chalta hai
                init() { 
                    if(localStorage.getItem('theme') === 'dark') { this.isDark = true; document.documentElement.classList.add('dark'); }
                    const cached = localStorage.getItem('vacuum_data');
                    if (cached) { try { this.pcs = JSON.parse(cached); this.loading = false; } catch (e) { this.loading = true; } } else { this.loading = true; }
                    this.fetchData(false); 
                },

                // Vibration helper
                haptic() { vibrateDevice(15); },

                // Dark/Light Mode toggle
                toggleTheme() {
                    this.haptic();
                    this.isDark = !this.isDark;
                    if(this.isDark) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } 
                    else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
                },

                // Filters change karna
                toggleFilter(status) {
                    this.haptic();
                    this.filterStatus = (this.filterStatus === status) ? 'ALL' : status;
                },

                // Data fetch karna Google Script se
                async fetchData(forceRefresh = false) {
                    if (forceRefresh) { this.isSyncing = true; this.haptic(); }
                    try {
                        const res = await fetch(API_URL + '?action=getVacuumData');
                        const data = await res.json();
                        // Col E (Asset ID) Mapping Logic
                        const processedData = data.pcs.map(p => {
                            const isDone = (p.status && String(p.status).trim().toUpperCase() === 'DONE');
                            return { 
                                systemName: p.id,        
                                assetId: p.assetId || '', // Yeh Col E se aa raha hai
                                os: p.os, 
                                status: isDone ? 'DONE' : 'PENDING', 
                                date: isDone ? p.date : '', 
                                updating: false 
                            };
                        });
                        this.pcs = processedData;
                        localStorage.setItem('vacuum_data', JSON.stringify(this.pcs));
                        if(forceRefresh) showToast("Synced Successfully");
                    } catch (e) { if (forceRefresh) showToast("Sync Failed", true); } 
                    finally { this.loading = false; this.isSyncing = false; }
                },

                // Date ko "3 Jan 2026" format mein dikhana
                formatDateDisplay(dateStr) {
                    if (!dateStr || dateStr === "N/A") return '';
                    let d = new Date(dateStr);
                    if (!isNaN(d.getTime())) return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    return dateStr;
                },

                // Date ko input box ke liye format karna
                convertDateForInput(dateStr) {
                    if (!dateStr || dateStr === "N/A") return '';
                    let d = new Date(dateStr);
                    if(!isNaN(d.getTime())) return d.toISOString().split('T')[0];
                    return ''; 
                },
				
                // OS ke icon decide karna
				getOsIcon(osName) {
					if (!osName) return 'fa-solid fa-desktop';
					const os = osName.toLowerCase();
					if (os.includes('server')) return 'fa-solid fa-server';
					if (os.includes('opensuse') || os.includes('linux')) return 'fa-brands fa-linux';
					if (os.includes('windows')) return 'fa-brands fa-windows';
					return 'fa-solid fa-desktop';
				},

                // Add/Edit Modal open karna
                openModal(mode, item = null) {
                    this.haptic();
                    this.mode = mode; this.form.secret = ''; 
                    if (mode === 'edit' && item) {
                        this.form.systemName = item.systemName;
                        this.form.assetId = item.assetId; 
                        this.form.os = item.os; 
                        this.form.status = item.status;
                        this.form.date = this.convertDateForInput(item.date); 
                    } else {
                        this.form = { systemName: '', assetId: '', os: 'Windows 11 Pro', status: 'PENDING', date: '', secret: '' };
                    }
                    this.showModal = true;
                },

                openConfirmModal() { this.haptic(); this.showConfirmModal = true; },

                // Agar status Done hai to aaj ki date auto-fill karna
                handleStatusChange() {
                    if (this.form.status === 'DONE') {
                        const today = new Date();
                        this.form.date = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    } else { this.form.date = ''; }
                },

                // Email Report bhejna
                async sendEmailReport() {
                    this.emailSending = true; this.haptic(); showToast("Sending Report...");
                    const date = new Date();
                    const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                    const payload = { action: 'sendReport', cycle: `${monthNames[date.getMonth()]} ${date.getFullYear()}`, totalCount: this.pcs.length, doneCount: this.doneCount, pendingCount: this.pendingCount };
                    try {
                        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                        const result = await res.json();
                        if(result.status === 'success') { vibrateDevice([100, 50, 100]); showToast("Email Sent!"); this.showReportModal = false; } else { showToast("Error", true); }
                    } catch(e) { showToast("Network Error", true); } 
                    finally { this.emailSending = false; }
                },

                // Save ya Delete Action perform karna
                async performAction(type) {
                    // Password Check
                    if (this.form.secret !== 'PBL2026') { vibrateDevice([50, 50, 50]); showToast("Wrong Key", true); return; }
                    this.haptic(); this.submitting = true;
                    
                    let payloadDate = this.form.date;
                    if (this.form.date && this.form.status === 'DONE') {
                        const d = new Date(this.form.date);
                        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                        payloadDate = `${d.getDate()}/${monthNames[d.getMonth()]}/${d.getFullYear()}`;
                    }
                    
                    const payload = {
                        action: 'handleVacuum', type: type === 'delete' ? 'delete' : 'save',
                        systemName: this.form.systemName, realAssetId: this.form.assetId,
                        os: this.form.os, status: this.form.status, date: payloadDate, secret: this.form.secret
                    };
                    try {
                        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                        const result = await res.json();
                        if (result.status === 'success') {
                            vibrateDevice([100, 50, 100]); this.showModal = false; showToast(type === 'delete' ? "Deleted" : "Saved");
                            await this.fetchData(true); 
                            // Agar sab complete ho gaya to celebration modal dikhana
                            if (this.pendingCount === 0 && this.pcs.length > 0 && type === 'save') { setTimeout(() => { this.showReportModal = true; }, 500); }
                        } else { showToast(result.message, true); }
                    } catch (e) { showToast("Network Error", true); } 
                    finally { this.submitting = false; }
                },

                // Filter aur Search Logic
                get filteredList() {
                    let result = this.pcs;
                    if (this.filterStatus === 'DONE') result = result.filter(p => p.status === 'DONE');
                    else if (this.filterStatus === 'PENDING') result = result.filter(p => p.status !== 'DONE');
                    if (this.search) {
                        const s = this.search.toLowerCase();
                        result = result.filter(p => (p.systemName && p.systemName.toLowerCase().includes(s)) || (p.assetId && p.assetId.toLowerCase().includes(s)));
                    }
                    return result;
                },
                get doneCount() { return this.pcs.filter(p => p.status === 'DONE').length; },
                get pendingCount() { return this.pcs.filter(p => p.status !== 'DONE').length; },
                get percentage() { if(this.pcs.length === 0) return 0; return Math.round((this.doneCount / this.pcs.length) * 100); }
            }))
        })
    </script>
</body>
</html>
