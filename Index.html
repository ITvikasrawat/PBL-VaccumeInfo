<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PBL VacuumOps | Rose Edition</title>
    
    <!-- âœ… Favicon -->
    <link rel="icon" type="image/png" href="pbl-logo.png">
    
    <!-- 
      LIBRARIES LOAD KAR RAHE HAIN 
      Tailwind: Design ke liye
      FontAwesome: Icons ke liye
      AlpineJS: Logic ke liye
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // ðŸŒ¹ THEME: Rose Red (User Requirement)
                        brand_primary: '#e11d48', // Main Red
                        brand_dark: '#be123c',    // Darker Red
                        brand_light: '#ffe4e6',   // Light Pink
                        dark_bg: '#0f172a'
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: {
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        slideUp: {
                            'from': { opacity: 0, transform: 'translateY(20px)' },
                            'to': { opacity: 1, transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }
        body { background-color: #fff1f2; /* Light Pink Background */ -webkit-tap-highlight-color: transparent; }
        
        /* ðŸ”¥ Header Gradient */
        .bg-gradient-brand { background: linear-gradient(135deg, #e11d48 0%, #9f1239 100%); }

        /* Glass Card Style */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 20px -5px rgba(225, 29, 72, 0.15);
            transition: transform 0.2s;
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px -5px rgba(0,0,0,0.5);
        }
        .glass-card:active { transform: scale(0.98); }

        /* Input Fields */
        .input-box {
            width: 100%; padding: 14px; background: #fff1f2; border: 2px solid transparent;
            border-radius: 14px; font-size: 0.9rem; color: #881337; outline: none; transition: 0.2s; font-weight: 700;
        }
        .dark .input-box { background: #0f172a; color: white; }
        .input-box:focus { background: white; border-color: #e11d48; box-shadow: 0 4px 12px rgba(225, 29, 72, 0.15); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>

<body class="text-slate-800 transition-colors duration-300 min-h-screen pb-32 font-sans bg-rose-50 dark:bg-[#0b1120] dark:text-slate-200" x-data="vacuumTracker()">

    <!-- HEADER SECTION -->
    <header class="relative pt-6 pb-16 px-5 overflow-hidden rounded-b-[2.5rem] shadow-xl bg-gradient-brand">
        
        <!-- Decoration Circles (Background Design) -->
        <div class="absolute top-[-20px] left-[-20px] w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
        <div class="absolute bottom-[-10px] right-[-10px] w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>

        <div class="relative z-10">
            <!-- Top Row: Logo & User -->
            <div class="flex justify-between items-center mb-5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 backdrop-blur-md rounded-xl flex items-center justify-center shadow-md border border-white/20" @click="haptic()">
                        <img src="pbl-logo.png" alt="Logo" class="w-6 h-6 object-contain">
                    </div>
                    <div>
                        <h1 class="text-xl font-black text-white leading-none tracking-tight">Vacuum<span class="opacity-80">Ops</span></h1>
                        <span class="text-[9px] text-white/90 font-bold uppercase tracking-wider flex items-center gap-1 mt-0.5">
                            <i class="fa-solid fa-user-circle"></i> Ashok Singh
                        </span>
                    </div>
                </div>
                
                <!-- Dark Mode Toggle -->
                <button @click="toggleTheme()" class="w-9 h-9 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center text-white border border-white/10 active:scale-95 transition">
                    <i class="fa-solid" :class="isDark ? 'fa-sun' : 'fa-moon'"></i>
                </button>
            </div>

            <!-- COMPACT STATS ROW -->
            <div class="flex gap-2">
                <!-- Cycle Card -->
                <div class="flex-1 bg-white/10 backdrop-blur-md border border-white/10 rounded-xl p-3 text-white">
                    <p class="text-[9px] opacity-70 font-bold uppercase">Current Cycle</p>
                    <p class="text-sm font-black flex items-center gap-1.5 mt-0.5">
                        <i class="fa-solid fa-calendar-check text-rose-200"></i> <span x-text="currentCycleName">...</span>
                    </p>
                </div>
                
                <!-- Progress Card -->
                <div class="flex-1 bg-white/10 backdrop-blur-md border border-white/10 rounded-xl p-3 text-white flex justify-between items-center">
                    <div>
                        <p class="text-[9px] opacity-70 font-bold uppercase">Done</p>
                        <p class="text-xl font-black leading-none mt-0.5"><span x-text="percentage">0</span>%</p>
                    </div>
                    <!-- Small Pie Chart -->
                    <div class="relative w-8 h-8">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="16" cy="16" r="14" stroke="rgba(255,255,255,0.2)" stroke-width="4" fill="transparent"/>
                            <circle cx="16" cy="16" r="14" stroke="white" stroke-width="4" fill="transparent" 
                                    :stroke-dasharray="88" :stroke-dashoffset="88 - (88 * percentage) / 100" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="px-4 -mt-6 relative z-20 max-w-lg mx-auto space-y-4">

        <!-- SEARCH BAR -->
        <div class="glass-card rounded-2xl p-2 flex items-center shadow-lg">
            <div class="w-10 h-10 flex items-center justify-center text-rose-400">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            <input type="text" x-model="search" placeholder="Search System or Asset ID..." 
                   class="flex-1 bg-transparent border-none text-sm font-bold text-slate-700 dark:text-white placeholder-slate-400 focus:ring-0">
        </div>

        <!-- 
           FILTER TABS (Toggle Logic Here)
           Agar filter active hai to Colored dikhega, nahi to Gray.
           Wapas click karne pe 'ALL' ho jayega.
        -->
        <div class="flex p-1 bg-rose-200/50 dark:bg-slate-800 rounded-xl">
            <!-- Completed Button -->
            <button @click="toggleFilter('DONE')" 
                    class="flex-1 py-2 text-xs font-bold transition-all rounded-lg"
                    :class="filterStatus === 'DONE' ? 'bg-white shadow-sm text-brand_primary dark:bg-slate-600 dark:text-white' : 'text-slate-500 hover:text-slate-700'">
                Completed (<span x-text="doneCount">0</span>)
            </button>
            
            <!-- Pending Button -->
            <button @click="toggleFilter('PENDING')" 
                    class="flex-1 py-2 text-xs font-bold transition-all rounded-lg"
                    :class="filterStatus === 'PENDING' ? 'bg-white shadow-sm text-brand_primary dark:bg-slate-600 dark:text-white' : 'text-slate-500 hover:text-slate-700'">
                Pending (<span x-text="pendingCount">0</span>)
            </button>
        </div>

        <!-- LOADING SPINNER -->
        <div x-show="loading" class="py-10 text-center">
            <div class="w-10 h-10 border-4 border-rose-100 border-t-brand_primary rounded-full animate-spin mx-auto mb-3"></div>
            <p class="text-[10px] font-bold text-rose-400 uppercase tracking-widest animate-pulse">Syncing Data...</p>
        </div>

        <!-- LIST ITEMS -->
        <div class="space-y-2.5 pb-24">
            <template x-for="(pc, index) in filteredList" :key="pc.systemName + index">
                <div class="glass-card p-3.5 rounded-2xl relative overflow-hidden group animate-slide-up flex items-center justify-between"
                     :style="`animation-delay: ${index * 30}ms`"
                     :class="pc.status === 'DONE' ? 'border-l-4 border-l-emerald-500' : 'border-l-4 border-l-brand_primary'"
                     @click="openModal('edit', pc)">
                    
                    <div class="flex items-center gap-3 w-full overflow-hidden">
                        <!-- Check/Clock Icon -->
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg shadow-sm transition-colors shrink-0"
                             :class="pc.status === 'DONE' ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-500 dark:text-white' : 'bg-rose-100 text-brand_primary dark:bg-brand_primary dark:text-white'">
                            <i class="fa-solid" :class="pc.status === 'DONE' ? 'fa-check' : 'fa-clock'"></i>
                        </div>

                        <div class="min-w-0 flex-1">
                            <!-- System Name -->
                            <h3 class="font-extrabold text-sm text-slate-800 dark:text-white truncate" x-text="pc.systemName"></h3>
                            
                            <!-- 
                               SPACE MANAGEMENT: 
                               Asset ID aur OS ek hi line mein, font size 9px/10px kar diya.
                               OS ka pura naam dikhega (No Trim).
                            -->
                            <div class="flex flex-wrap items-center gap-2 mt-1">
                                <!-- Asset ID Pill -->
                                <span class="text-[9px] font-mono font-bold text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-700 whitespace-nowrap" 
                                      x-text="pc.assetId ? pc.assetId : 'No ID'"></span>
                                
                                <!-- OS Name (Full Visible) -->
                                <span class="text-[9px] text-slate-400 font-bold uppercase flex items-center gap-1 whitespace-nowrap">
                                    <i :class="getOsIcon(pc.os)"></i> <span x-text="pc.os"></span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side: Date or Arrow -->
                    <div class="text-right shrink-0 pl-2">
                        <template x-if="pc.status === 'DONE'">
                            <div class="flex flex-col items-end">
                                <span class="text-[8px] font-black text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-100">CLEAN</span>
                                <p class="text-[9px] font-bold text-slate-400 mt-0.5" x-text="formatDateDisplay(pc.date)"></p>
                            </div>
                        </template>
                        <template x-if="pc.status !== 'DONE'">
                            <i class="fa-solid fa-chevron-right text-rose-300 text-xs"></i>
                        </template>
                    </div>

                    <!-- Loader Overlay -->
                    <div x-show="pc.updating" class="absolute inset-0 bg-white/80 dark:bg-black/60 backdrop-blur-sm z-20 flex items-center justify-center">
                        <i class="fa-solid fa-circle-notch fa-spin text-brand_primary text-xl"></i>
                    </div>
                </div>
            </template>

            <!-- Empty State -->
            <div x-show="filteredList.length === 0 && !loading" class="text-center py-12 opacity-50">
                <i class="fa-solid fa-filter-circle-xmark text-3xl text-rose-300 mb-2"></i>
                <p class="text-xs font-bold text-rose-400">No matching assets</p>
                <button @click="filterStatus = 'ALL'; search = ''" x-show="filterStatus !== 'ALL' || search" class="mt-3 text-[10px] font-bold text-white bg-rose-400 px-3 py-1.5 rounded-full">Reset</button>
            </div>
        </div>
    </main>

    <!-- FAB (Floating Button) -->
    <button @click="openModal('add')" class="fixed bottom-20 right-5 w-12 h-12 bg-gradient-to-br from-brand_primary to-brand_dark rounded-full text-white shadow-xl shadow-brand_primary/40 flex items-center justify-center active:scale-90 transition-transform z-40">
        <i class="fa-solid fa-plus text-lg"></i>
    </button>

    <!-- FOOTER -->
    <footer class="fixed bottom-0 left-0 w-full bg-white/95 dark:bg-[#0f172a]/95 backdrop-blur-lg border-t border-rose-100 dark:border-white/5 px-5 py-3 z-50 flex justify-between items-center">
        <div>
            <p class="text-[9px] font-bold text-rose-300 uppercase tracking-widest">Operator</p>
            <p class="text-xs font-black text-slate-800 dark:text-white">Ashok Singh <span class="text-[8px] bg-rose-100 text-brand_primary px-1 rounded ml-1">IT</span></p>
        </div>
        <div class="flex gap-2">
            <button @click="fetchData(true)" class="w-9 h-9 rounded-lg bg-rose-50 dark:bg-white/10 flex items-center justify-center text-rose-400 dark:text-slate-300 active:scale-95 transition">
                <i class="fa-solid fa-rotate" :class="{'fa-spin': isSyncing}"></i>
            </button>
            <button @click="openConfirmModal()" class="px-4 h-9 rounded-lg bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold text-[10px] flex items-center gap-2 shadow-lg active:scale-95 transition" :disabled="emailSending">
                <i class="fa-solid fa-file-export"></i> Report
            </button>
        </div>
    </footer>

    <!-- MODALS (Hidden by default) -->
    
    <!-- Edit/Add Modal -->
    <div x-show="showModal" x-cloak 
         class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-full"
         x-transition:enter-end="opacity-100 translate-y-0">
        
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-6 shadow-2xl relative" @click.away="showModal = false">
            <div class="absolute top-3 left-1/2 -translate-x-1/2 w-10 h-1 bg-slate-200 dark:bg-slate-700 rounded-full sm:hidden"></div>
            
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-xl font-black text-slate-800 dark:text-white" x-text="mode === 'add' ? 'New Entry' : 'Edit Details'"></h3>
                <button @click="showModal = false" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-white/10 text-slate-500 flex items-center justify-center hover:text-brand_primary"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="space-y-3">
                <!-- System Name -->
                <div>
                    <label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">System Name</label>
                    <input type="text" x-model="form.systemName" class="input-box uppercase" placeholder="PBLNET001">
                </div>
                <!-- Asset ID -->
                <div>
                    <label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">Asset Tag / ID</label>
                    <input type="text" x-model="form.assetId" class="input-box font-mono text-sm" placeholder="e.g. PBL-NOD-IT-CPU-001">
                </div>
                <!-- OS Dropdown -->
                <div>
                    <label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">Operating System</label>
                    <div class="relative">
                        <select x-model="form.os" class="input-box appearance-none">
                            <option value="Windows 11 Pro">Windows 11 Pro</option>
                            <option value="Windows 10">Windows 10</option>
                            <option value="Windows XP">Windows XP</option>
                            <option value="Windows Server 2019">Windows Server 2019</option>
                            <option value="OpenSuse">OpenSuse Linux</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-rose-400 pointer-events-none"></i>
                    </div>
                </div>
                <!-- Status & Date -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">Status</label>
                        <div class="relative">
                            <select x-model="form.status" @change="handleStatusChange()" class="input-box appearance-none"
                                    :class="form.status === 'DONE' ? 'text-emerald-600 bg-emerald-50' : 'text-brand_primary bg-rose-50'">
                                <option value="PENDING">Pending</option>
                                <option value="DONE">Cleaned</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-rose-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">Date</label>
                        <input type="date" x-model="form.date" class="input-box" :disabled="form.status !== 'DONE'">
                    </div>
                </div>
                <!-- Password -->
                <div class="pt-1">
                    <label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">Passkey</label>
                    <input type="password" x-model="form.secret" placeholder="Required for Save" class="input-box border-dashed border-rose-200">
                </div>
                <!-- Buttons -->
                <div class="flex gap-3 pt-3 mt-1">
                    <button x-show="mode === 'edit'" @click="performAction('delete')" class="w-12 h-12 rounded-xl bg-rose-50 text-brand_primary flex items-center justify-center text-lg"><i class="fa-solid fa-trash"></i></button>
                    <button @click="performAction('save')" class="flex-1 h-12 rounded-xl bg-brand_primary text-white font-bold text-sm shadow-xl flex items-center justify-center gap-2 active:scale-95 transition">
                        <span x-text="submitting ? 'Saving...' : 'Save Changes'"></span>
                        <i x-show="!submitting" class="fa-solid fa-check"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div x-show="showConfirmModal" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center bg-black/70 backdrop-blur-md p-6">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-xs rounded-[2rem] p-6 text-center shadow-2xl">
            <div class="w-14 h-14 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-3 text-brand_primary text-2xl"><i class="fa-solid fa-paper-plane"></i></div>
            <h3 class="text-lg font-black text-slate-800 dark:text-white">Send Report?</h3>
            <p class="text-xs text-slate-500 mb-5">Email status report to IT Head.</p>
            <div class="flex gap-2">
                <button @click="showConfirmModal = false" class="flex-1 py-3 bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-slate-300 rounded-xl font-bold text-xs">Cancel</button>
                <button @click="sendEmailReport(); showConfirmModal = false" class="flex-1 py-3 bg-brand_primary text-white rounded-xl font-bold text-xs shadow-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div x-show="showReportModal" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-md p-6">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-sm rounded-[2rem] p-8 text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-rose-400 to-pink-500"></div>
            <div class="w-20 h-20 bg-rose-100 dark:bg-brand_primary/30 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl animate-bounce">ðŸŽ‰</div>
            <h3 class="text-2xl font-black text-slate-800 dark:text-white mb-2">Complete!</h3>
            <p class="text-sm text-slate-500 mb-6">Cycle <span x-text="currentCycleName" class="font-bold text-brand_primary"></span> finished.</p>
            <button @click="sendEmailReport()" class="w-full py-3.5 bg-brand_primary text-white rounded-xl font-bold text-sm shadow-lg">Send Closure Report</button>
            <button @click="showReportModal = false" class="mt-4 text-xs font-bold text-slate-400">Close</button>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-5 py-2.5 rounded-full shadow-2xl flex items-center gap-3 z-[120] transition-all duration-300 opacity-0 pointer-events-none transform -translate-y-10">
        <i class="fa-solid fa-circle-check text-rose-400"></i>
        <span id="toast-msg" class="text-xs font-bold">Action Done</span>
    </div>

    <!-- SCRIPT (Logic Section) -->
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzcC-725iqJopRom9r_vGd5bZ2WKxTS0ZKDTWkflUZXluqzPWSkok1PPzyosA7QJ7G4Og/exec";  

        // Toast: Message popup
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.innerText = msg;
            toast.querySelector('i').className = isError ? 'fa-solid fa-circle-exclamation text-amber-400' : 'fa-solid fa-circle-check text-rose-400';
            toast.classList.remove('opacity-0', '-translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 3000);
        }

        // Haptic: Vibration
        function vibrateDevice(pattern = [50]) {
            if ("vibrate" in navigator) navigator.vibrate(pattern);
        }

        document.addEventListener('alpine:init', () => {
            Alpine.data('vacuumTracker', () => ({
                pcs: [], search: '', loading: false, isSyncing: false, submitting: false, showModal: false, showReportModal: false, showConfirmModal: false, emailSending: false, isDark: false, mode: 'add', filterStatus: 'ALL',
                form: { systemName: '', assetId: '', os: 'Windows 11 Pro', status: 'PENDING', date: '', secret: '' },
                currentCycleName: '', nextCycleName: '', cycleStartDate: null,

                init() { 
                    if(localStorage.getItem('theme') === 'dark') { this.isDark = true; document.documentElement.classList.add('dark'); }
                    this.calculateCycle(); 
                    const cached = localStorage.getItem('vacuum_data');
                    if (cached) { try { this.pcs = JSON.parse(cached); this.loading = false; } catch (e) { this.loading = true; } } else { this.loading = true; }
                    this.fetchData(false); 
                },

                haptic() { vibrateDevice(15); },

                toggleTheme() {
                    this.haptic(); this.isDark = !this.isDark;
                    if(this.isDark) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } 
                    else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
                },

                // ðŸ”„ TOGGLE FILTER LOGIC
                // Agar same button dubara click kiya -> Reset to ALL
                toggleFilter(status) {
                    this.haptic();
                    if (this.filterStatus === status) {
                        this.filterStatus = 'ALL'; // Uncheck (Show All)
                    } else {
                        this.filterStatus = status; // Apply new filter
                    }
                },

                // ðŸ§  CYCLE LOGIC (Jan, May, Sept)
                calculateCycle() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = now.getMonth(); 

                    let startMonth;
                    if (month >= 0 && month < 4) { 
                        startMonth = 0; this.currentCycleName = `JAN ${year}`; this.nextCycleName = `MAY ${year}`;
                    } else if (month >= 4 && month < 8) { 
                        startMonth = 4; this.currentCycleName = `MAY ${year}`; this.nextCycleName = `SEPT ${year}`;
                    } else { 
                        startMonth = 8; this.currentCycleName = `SEPT ${year}`; this.nextCycleName = `JAN ${year + 1}`;
                    }
                    this.cycleStartDate = new Date(year, startMonth, 1);
                },

                // ðŸŒ FETCH & RESET LOGIC
                async fetchData(forceRefresh = false) {
                    if (forceRefresh) { this.isSyncing = true; this.haptic(); }
                    try {
                        const res = await fetch(API_URL + '?action=getVacuumData');
                        const data = await res.json();
                        
                        // Check Date for Cycle Reset
                        const processedData = data.pcs.map(p => {
                            let isDone = (p.status && String(p.status).trim().toUpperCase() === 'DONE');
                            if (isDone && p.date) {
                                const recordDate = new Date(p.date);
                                if (recordDate < this.cycleStartDate) isDone = false; 
                            }
                            return { 
                                systemName: p.id, assetId: p.assetId || '', os: p.os, 
                                status: isDone ? 'DONE' : 'PENDING', date: isDone ? p.date : '', updating: false 
                            };
                        });
                        this.pcs = processedData;
                        localStorage.setItem('vacuum_data', JSON.stringify(this.pcs));
                        if(forceRefresh) showToast("Synced");
                    } catch (e) { if (forceRefresh) showToast("Error", true); } 
                    finally { this.loading = false; this.isSyncing = false; }
                },

                formatDateDisplay(dateStr) {
                    if (!dateStr || dateStr === "N/A") return '';
                    let d = new Date(dateStr);
                    if (!isNaN(d.getTime())) return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' });
                    return dateStr;
                },

                convertDateForInput(dateStr) {
                    if (!dateStr || dateStr === "N/A") return '';
                    let d = new Date(dateStr);
                    if(!isNaN(d.getTime())) return d.toISOString().split('T')[0];
                    return ''; 
                },
				
				getOsIcon(osName) {
					if (!osName) return 'fa-solid fa-desktop';
					const os = osName.toLowerCase();
					if (os.includes('server')) return 'fa-solid fa-server';
					if (os.includes('opensuse') || os.includes('linux')) return 'fa-brands fa-linux';
					if (os.includes('windows')) return 'fa-brands fa-windows';
					return 'fa-solid fa-desktop';
				},

                openModal(mode, item = null) {
                    this.haptic();
                    this.mode = mode; this.form.secret = ''; 
                    if (mode === 'edit' && item) {
                        this.form.systemName = item.systemName;
                        this.form.assetId = item.assetId; 
                        this.form.os = item.os; 
                        this.form.status = item.status;
                        if (item.status === 'PENDING') this.form.date = '';
                        else this.form.date = this.convertDateForInput(item.date); 
                    } else {
                        this.form = { systemName: '', assetId: '', os: 'Windows 11 Pro', status: 'PENDING', date: '', secret: '' };
                    }
                    this.showModal = true;
                },

                openConfirmModal() { this.haptic(); this.showConfirmModal = true; },

                handleStatusChange() {
                    if (this.form.status === 'DONE') {
                        const today = new Date();
                        const y = today.getFullYear();
                        const m = String(today.getMonth() + 1).padStart(2, '0');
                        const d = String(today.getDate()).padStart(2, '0');
                        this.form.date = `${y}-${m}-${d}`;
                    } else { this.form.date = ''; }
                },

                async sendEmailReport() {
                    this.emailSending = true; this.haptic(); showToast("Sending...");
                    const payload = { action: 'sendReport', cycle: this.currentCycleName, totalCount: this.pcs.length, doneCount: this.doneCount, pendingCount: this.pendingCount };
                    try {
                        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                        const result = await res.json();
                        if(result.status === 'success') { vibrateDevice([100, 50, 100]); showToast("Sent!"); this.showReportModal = false; } else { showToast("Error", true); }
                    } catch(e) { showToast("Network Error", true); } 
                    finally { this.emailSending = false; }
                },

                async performAction(type) {
                    if (this.form.secret !== 'PBL2026') { vibrateDevice([50, 50, 50]); showToast("Wrong Key", true); return; }
                    this.haptic(); this.submitting = true;
                    
                    let payloadDate = this.form.date;
                    if (this.form.date && this.form.status === 'DONE') {
                        const d = new Date(this.form.date);
                        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                        payloadDate = `${d.getDate()} ${monthNames[d.getMonth()]} ${d.getFullYear()}`;
                    }
                    
                    const payload = {
                        action: 'handleVacuum', type: type === 'delete' ? 'delete' : 'save',
                        systemName: this.form.systemName, realAssetId: this.form.assetId,
                        os: this.form.os, status: this.form.status, date: payloadDate, secret: this.form.secret
                    };
                    try {
                        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                        const result = await res.json();
                        if (result.status === 'success') {
                            vibrateDevice([100, 50, 100]); this.showModal = false; showToast(type === 'delete' ? "Deleted" : "Saved");
                            await this.fetchData(true); 
                            if (this.pendingCount === 0 && this.pcs.length > 0 && type === 'save') { setTimeout(() => { this.showReportModal = true; }, 500); }
                        } else { showToast(result.message, true); }
                    } catch (e) { showToast("Network Error", true); } 
                    finally { this.submitting = false; }
                },

                get filteredList() {
                    let result = this.pcs;
                    if (this.filterStatus === 'DONE') result = result.filter(p => p.status === 'DONE');
                    else if (this.filterStatus === 'PENDING') result = result.filter(p => p.status !== 'DONE');
                    if (this.search) {
                        const s = this.search.toLowerCase();
                        result = result.filter(p => (p.systemName && p.systemName.toLowerCase().includes(s)) || (p.assetId && p.assetId.toLowerCase().includes(s)));
                    }
                    return result;
                },
                get doneCount() { return this.pcs.filter(p => p.status === 'DONE').length; },
                get pendingCount() { return this.pcs.filter(p => p.status !== 'DONE').length; },
                get percentage() { if(this.pcs.length === 0) return 0; return Math.round((this.doneCount / this.pcs.length) * 100); }
            }))
        })
    </script>
</body>
</html>
