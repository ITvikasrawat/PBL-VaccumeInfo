<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PBL VacuumOps | Pop-out Edition</title>
    <link rel="icon" type="image/png" href="pbl-logo.png">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // ðŸŒ¹ THEME: Rose Red
                        brand_primary: '#e11d48', // Rose-600
                        brand_dark: '#be123c',    // Rose-700
                        brand_light: '#fff1f2',   // Rose-50
                        dark_bg: '#0f172a'
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'slide-up': 'slideUp 0.3s ease-out forwards' },
                    keyframes: { slideUp: { 'from': { opacity: 0, transform: 'translateY(10px)' }, 'to': { opacity: 1, transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        body { background-color: #fff1f2; -webkit-tap-highlight-color: transparent; }
        
        .glass-card { background: white; border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(225, 29, 72, 0.1); }
        .dark .glass-card { background: #1e293b; border-color: #334155; }
        
        /* ðŸ”¥ Gradient */
        .bg-gradient-brand { background: linear-gradient(135deg, #e11d48 0%, #be123c 100%); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>

<body class="text-slate-800 transition-colors duration-300 min-h-screen pb-32 font-sans bg-brand_bg dark:bg-dark_bg dark:text-slate-200" x-data="vacuumTracker()">

    <!-- HEADER SECTION -->
    <header class="relative pt-6 pb-20 px-5 rounded-b-[2.5rem] shadow-lg bg-gradient-brand z-30 overflow-hidden">
        
        <!-- Decor -->
        <div class="absolute top-[-20px] left-[-20px] w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
        <div class="absolute bottom-[-10px] right-[-10px] w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>

        <div class="relative z-10">
            <!-- Top Nav -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 backdrop-blur-md rounded-xl flex items-center justify-center shadow-inner border border-white/20">
                        <img src="pbl-logo.png" alt="Logo" class="w-6 h-6 object-contain">
                    </div>
                    <div>
                        <h1 class="text-xl font-black text-white leading-none">VacuumOps</h1>
                        <span class="text-[10px] text-white/90 font-bold uppercase tracking-wider flex items-center gap-1">
                            <i class="fa-solid fa-user-shield"></i> Ashok Singh
                        </span>
                    </div>
                </div>
                <button @click="toggleTheme()" class="w-9 h-9 rounded-full bg-white/10 flex items-center justify-center text-white border border-white/10 active:scale-95">
                    <i class="fa-solid" :class="isDark ? 'fa-sun' : 'fa-moon'"></i>
                </button>
            </div>

            <!-- Search Bar -->
            <div class="relative">
                <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-1/2 -translate-y-1/2 text-white/60 text-sm"></i>
                <input type="text" x-model="search" placeholder="Search System Name or Asset ID..." 
                       class="w-full pl-10 pr-4 py-3 bg-white/15 backdrop-blur-md border border-white/10 rounded-xl text-xs font-bold text-white placeholder-white/50 focus:outline-none focus:bg-white/20 transition">
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="px-4 -mt-10 relative z-40 max-w-lg mx-auto space-y-5">

        <!-- 
           ðŸš€ UPDATED DASHBOARD STRIP 
           - Thicker (py-4)
           - Pop-out Center Circle
           - Next Cycle Info Added
        -->
        <div class="glass-card relative px-4 py-4 rounded-3xl flex items-center justify-between shadow-xl mt-4 overflow-visible">
            
            <!-- Left: Cycle Info (Stacked) -->
            <div class="flex flex-col gap-1">
                <div class="flex items-center gap-1.5 text-slate-500 dark:text-slate-400">
                    <i class="fa-solid fa-calendar-check text-[10px]"></i>
                    <p class="text-[9px] font-bold uppercase tracking-wide">Current</p>
                </div>
                <p class="text-sm font-black text-brand_primary leading-none" x-text="currentCycleName">JAN 26</p>
                
                <!-- Next Cycle Added -->
                <div class="flex items-center gap-1 mt-1 text-[9px] font-bold text-slate-400 bg-slate-100 dark:bg-white/5 px-2 py-0.5 rounded-full w-fit">
                    <span>Next:</span>
                    <span class="text-slate-600 dark:text-slate-300" x-text="nextCycleName">MAY 26</span>
                </div>
            </div>

            <!-- 
               Center: POP-OUT PROGRESS CIRCLE 
               - Absolute Positioning to break border
               - White Background & Shadow
            -->
            <div class="absolute left-1/2 top-0 -translate-x-1/2 -translate-y-1/2 w-20 h-20 bg-white dark:bg-[#1e293b] rounded-full p-1.5 shadow-[0_8px_30px_rgba(225,29,72,0.25)] flex items-center justify-center z-50">
                <div class="relative w-full h-full">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="50%" cy="50%" r="28" stroke="#ffe4e6" stroke-width="5" fill="transparent" />
                        <circle cx="50%" cy="50%" r="28" stroke="#e11d48" stroke-width="5" fill="transparent" 
                                :stroke-dasharray="175" :stroke-dashoffset="175 - (175 * percentage) / 100" stroke-linecap="round"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center leading-none">
                        <span class="text-sm font-black text-brand_primary" x-text="percentage + '%'">0%</span>
                    </div>
                </div>
            </div>

            <!-- Right: Filter Toggles -->
            <div class="flex gap-1.5">
                <!-- Done -->
                <button @click="toggleFilter('DONE')" 
                        class="flex flex-col items-center justify-center w-12 h-11 rounded-xl transition-all"
                        :class="filterStatus === 'DONE' ? 'bg-emerald-500 text-white shadow-md shadow-emerald-200' : 'text-emerald-600 bg-emerald-50 hover:bg-emerald-100'">
                    <i class="fa-solid fa-check text-xs mb-0.5"></i>
                    <span class="text-[10px] font-bold" x-text="doneCount">0</span>
                </button>
                
                <!-- Pending -->
                <button @click="toggleFilter('PENDING')" 
                        class="flex flex-col items-center justify-center w-12 h-11 rounded-xl transition-all"
                        :class="filterStatus === 'PENDING' ? 'bg-brand_primary text-white shadow-md shadow-rose-200' : 'text-brand_primary bg-rose-50 hover:bg-rose-100'">
                    <i class="fa-regular fa-clock text-xs mb-0.5"></i>
                    <span class="text-[10px] font-bold" x-text="pendingCount">0</span>
                </button>
            </div>
        </div>

        <!-- LOADING -->
        <div x-show="loading" class="py-8 text-center">
            <div class="w-8 h-8 border-4 border-rose-200 border-t-brand_primary rounded-full animate-spin mx-auto mb-2"></div>
            <p class="text-[10px] font-bold text-rose-400 uppercase tracking-widest animate-pulse">Syncing Database...</p>
        </div>

        <!-- ASSET LIST -->
        <div class="space-y-2 pb-24 pt-2">
            <template x-for="(pc, index) in filteredList" :key="pc.systemName + index">
                <div class="glass-card p-3 rounded-2xl relative overflow-hidden group animate-slide-up flex items-center justify-between shadow-sm active:scale-[0.99] transition-transform"
                     :style="`animation-delay: ${index * 30}ms`"
                     :class="pc.status === 'DONE' ? 'border-l-4 border-l-emerald-500' : 'border-l-4 border-l-brand_primary'"
                     @click="openModal('edit', pc)">
                    
                    <div class="flex items-center gap-3 w-full overflow-hidden">
                        <!-- Icon -->
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg shrink-0"
                             :class="pc.status === 'DONE' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-brand_primary'">
                            <i class="fa-solid" :class="pc.status === 'DONE' ? 'fa-check' : 'fa-clock'"></i>
                        </div>

                        <div class="min-w-0 flex-1">
                            <!-- System Name -->
                            <h3 class="font-extrabold text-sm text-slate-800 dark:text-white truncate" x-text="pc.systemName"></h3>
                            
                            <!-- Metadata Row (ID + OS) -->
                            <div class="flex flex-wrap items-center gap-2 mt-0.5">
                                <span class="text-[9px] font-mono font-bold text-slate-500 bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded truncate max-w-[120px]" 
                                      x-text="pc.assetId ? pc.assetId : 'No ID'"></span>
                                <span class="text-[8px] font-bold text-slate-400 uppercase flex items-center gap-1">
                                    <i :class="getOsIcon(pc.os)"></i> <span x-text="pc.os"></span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Status Label -->
                    <div class="text-right shrink-0 pl-2">
                        <template x-if="pc.status === 'DONE'">
                            <div class="flex flex-col items-end">
                                <span class="text-[8px] font-black text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-100">CLEAN</span>
                                <p class="text-[8px] font-bold text-slate-400 mt-0.5" x-text="formatDateDisplay(pc.date)"></p>
                            </div>
                        </template>
                        <template x-if="pc.status !== 'DONE'">
                            <i class="fa-solid fa-chevron-right text-rose-300 text-xs"></i>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Empty State -->
            <div x-show="filteredList.length === 0 && !loading" class="text-center py-10 opacity-50">
                <i class="fa-solid fa-filter-circle-xmark text-3xl text-rose-300 mb-2"></i>
                <p class="text-xs font-bold text-rose-400">No assets found</p>
                <button @click="filterStatus = 'ALL'; search = ''" x-show="filterStatus !== 'ALL' || search" class="mt-3 text-[10px] font-bold text-white bg-brand_primary px-3 py-1.5 rounded-full">Clear Filters</button>
            </div>
        </div>
    </main>

    <!-- FAB -->
    <button @click="openModal('add')" class="fixed bottom-20 right-5 w-12 h-12 bg-gradient-to-br from-brand_primary to-brand_dark rounded-full text-white shadow-xl shadow-brand_primary/40 flex items-center justify-center active:scale-90 transition-transform z-40">
        <i class="fa-solid fa-plus text-lg"></i>
    </button>

    <!-- FOOTER -->
    <footer class="fixed bottom-0 left-0 w-full bg-white/95 dark:bg-[#0f172a]/95 backdrop-blur-lg border-t border-rose-100 dark:border-white/5 px-5 py-3 z-50 flex justify-between items-center">
        <div>
            <p class="text-[8px] font-bold text-rose-300 uppercase tracking-widest">Operator</p>
            <p class="text-xs font-black text-slate-800 dark:text-white">Ashok Singh <span class="text-[8px] bg-rose-100 text-brand_primary px-1 rounded ml-1">IT</span></p>
        </div>
        <div class="flex gap-2">
            <button @click="fetchData(true)" class="w-9 h-9 rounded-lg bg-rose-50 dark:bg-white/10 flex items-center justify-center text-rose-400 dark:text-slate-300 active:scale-95 transition">
                <i class="fa-solid fa-rotate" :class="{'fa-spin': isSyncing}"></i>
            </button>
            <button @click="openConfirmModal()" class="px-4 h-9 rounded-lg bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold text-[10px] flex items-center gap-2 shadow-lg active:scale-95 transition" :disabled="emailSending">
                <i class="fa-solid fa-file-export"></i> Report
            </button>
        </div>
    </footer>

    <!-- MODAL: ADD/EDIT -->
    <div x-show="showModal" x-cloak class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-4">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-6 shadow-2xl relative" @click.away="showModal = false">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-xl font-black text-slate-800 dark:text-white" x-text="mode === 'add' ? 'New Entry' : 'Edit Details'"></h3>
                <button @click="showModal = false" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-white/10 text-slate-500 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-3">
                <div><label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">System Name</label><input type="text" x-model="form.systemName" class="w-full p-3 bg-rose-50 rounded-xl text-sm font-bold border-2 border-transparent focus:border-brand_primary focus:bg-white outline-none uppercase" placeholder="PBLNET001"></div>
                <div><label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">Asset Tag</label><input type="text" x-model="form.assetId" class="w-full p-3 bg-rose-50 rounded-xl text-sm font-mono font-bold border-2 border-transparent focus:border-brand_primary focus:bg-white outline-none" placeholder="PBL-NOD-IT-CPU-001"></div>
                <div>
                    <label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">OS</label>
                    <select x-model="form.os" class="w-full p-3 bg-rose-50 rounded-xl text-sm font-bold border-2 border-transparent focus:border-brand_primary outline-none">
                        <option value="Windows 11 Pro">Windows 11 Pro</option><option value="Windows 10">Windows 10</option><option value="Windows XP">Windows XP</option><option value="Windows Server 2019">Windows Server 2019</option><option value="OpenSuse">OpenSuse</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">Status</label><select x-model="form.status" @change="handleStatusChange()" class="w-full p-3 bg-rose-50 rounded-xl text-sm font-bold outline-none" :class="form.status === 'DONE' ? 'text-emerald-600' : 'text-brand_primary'"><option value="PENDING">Pending</option><option value="DONE">Cleaned</option></select></div>
                    <div><label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">Date</label><input type="date" x-model="form.date" class="w-full p-3 bg-rose-50 rounded-xl text-sm font-bold outline-none" :disabled="form.status !== 'DONE'"></div>
                </div>
                <div><label class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1 block">Passkey</label><input type="password" x-model="form.secret" class="w-full p-3 bg-white border-2 border-dashed border-rose-200 rounded-xl text-sm font-bold focus:border-brand_primary outline-none" placeholder="Required to Save"></div>
                <div class="flex gap-3 pt-2">
                    <button x-show="mode === 'edit'" @click="performAction('delete')" class="w-12 h-12 bg-rose-50 text-brand_primary rounded-xl flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                    <button @click="performAction('save')" class="flex-1 h-12 bg-brand_primary text-white rounded-xl font-bold text-sm shadow-lg flex items-center justify-center gap-2"><span>Save</span> <i x-show="submitting" class="fa-solid fa-circle-notch fa-spin"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div x-show="showConfirmModal" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center bg-black/70 backdrop-blur-md p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 text-center shadow-2xl">
            <h3 class="text-lg font-black text-slate-800">Send Report?</h3>
            <p class="text-xs text-slate-500 mb-4">Email status to IT Head.</p>
            <div class="flex gap-2"><button @click="showConfirmModal = false" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-xs">Cancel</button><button @click="sendEmailReport(); showConfirmModal = false" class="flex-1 py-3 bg-brand_primary text-white rounded-xl font-bold text-xs shadow-lg">Confirm</button></div>
        </div>
    </div>

    <!-- Success Modal -->
    <div x-show="showReportModal" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-md p-6">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 text-center shadow-2xl relative overflow-hidden">
            <div class="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl animate-bounce">ðŸŽ‰</div>
            <h3 class="text-xl font-black text-slate-800">Complete!</h3>
            <p class="text-xs text-slate-500 mb-6">Cycle <span x-text="currentCycleName" class="font-bold text-brand_primary"></span> finished.</p>
            <button @click="sendEmailReport()" class="w-full py-3 bg-brand_primary text-white rounded-xl font-bold text-xs shadow-lg">Send Closure Report</button>
            <button @click="showReportModal = false" class="mt-4 text-xs font-bold text-slate-400">Close</button>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-5 py-2.5 rounded-full shadow-2xl flex items-center gap-3 z-[120] transition-all duration-300 opacity-0 pointer-events-none transform -translate-y-10">
        <i class="fa-solid fa-check-circle text-rose-400"></i>
        <span id="toast-msg" class="text-xs font-bold">Action Done</span>
    </div>

    <!-- LOGIC -->
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbx4DM9p35wv3S0Mip26IGmr7jJHwC9sUTxj9oeymjx-hXjHNCZwbYlis5dmoCcUiiUV7A/exec";  

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.querySelector('i').className = isError ? 'fa-solid fa-circle-exclamation text-amber-400' : 'fa-solid fa-check-circle text-rose-400';
            toast.classList.remove('opacity-0', '-translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 3000);
        }

        function vibrateDevice(pattern = [50]) {
            if ("vibrate" in navigator) navigator.vibrate(pattern);
        }

        document.addEventListener('alpine:init', () => {
            Alpine.data('vacuumTracker', () => ({
                pcs: [], search: '', loading: false, isSyncing: false, submitting: false, showModal: false, showReportModal: false, showConfirmModal: false, emailSending: false, isDark: false, mode: 'add', filterStatus: 'ALL',
                form: { systemName: '', assetId: '', os: 'Windows 11 Pro', status: 'PENDING', date: '', secret: '' },
                currentCycleName: '', nextCycleName: '', cycleStartDate: null,

                init() { 
                    if(localStorage.getItem('theme') === 'dark') { this.isDark = true; document.documentElement.classList.add('dark'); }
                    this.calculateCycle(); 
                    const cached = localStorage.getItem('vacuum_data');
                    if (cached) { try { this.pcs = JSON.parse(cached); this.loading = false; } catch (e) { this.loading = true; } } else { this.loading = true; }
                    this.fetchData(false); 
                },

                haptic() { vibrateDevice(15); },

                toggleTheme() {
                    this.haptic(); this.isDark = !this.isDark;
                    if(this.isDark) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } 
                    else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
                },

                // âœ… Toggle Filter (Clicking same filter unchecks it)
                toggleFilter(status) {
                    this.haptic();
                    if (this.filterStatus === status) {
                        this.filterStatus = 'ALL';
                    } else {
                        this.filterStatus = status;
                    }
                },

                calculateCycle() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = now.getMonth(); 
                    let startMonth;
                    if (month >= 0 && month < 4) { 
                        startMonth = 0; this.currentCycleName = `JAN ${year}`; this.nextCycleName = `MAY ${year}`;
                    } else if (month >= 4 && month < 8) { 
                        startMonth = 4; this.currentCycleName = `MAY ${year}`; this.nextCycleName = `SEPT ${year}`;
                    } else { 
                        startMonth = 8; this.currentCycleName = `SEPT ${year}`; this.nextCycleName = `JAN ${year + 1}`;
                    }
                    this.cycleStartDate = new Date(year, startMonth, 1);
                },

                async fetchData(forceRefresh = false) {
                    if (forceRefresh) { this.isSyncing = true; this.loading = true; } 
                    try {
                        const res = await fetch(API_URL + '?action=getVacuumData');
                        const data = await res.json();
                        const processedData = data.pcs.map(p => {
                            let isDone = (p.status && String(p.status).trim().toUpperCase() === 'DONE');
                            if (isDone && p.date) {
                                const recordDate = new Date(p.date);
                                if (recordDate < this.cycleStartDate) isDone = false; // Auto Reset
                            }
                            // Asset ID Mapping (Col E)
                            return { 
                                systemName: p.id, 
                                assetId: p.assetId || '', 
                                os: p.os, 
                                status: isDone ? 'DONE' : 'PENDING', 
                                date: isDone ? p.date : '', 
                                updating: false 
                            };
                        });
                        this.pcs = processedData;
                        localStorage.setItem('vacuum_data', JSON.stringify(this.pcs));
                        if(forceRefresh) showToast("Synced");
                    } catch (e) { if(forceRefresh) showToast("Sync Error", true); } 
                    finally { this.loading = false; this.isSyncing = false; }
                },

                formatDateDisplay(dateStr) {
                    if (!dateStr || dateStr === "N/A") return '';
                    let d = new Date(dateStr);
                    return !isNaN(d.getTime()) ? d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' }) : dateStr;
                },

                convertDateForInput(dateStr) {
                    if (!dateStr) return '';
                    let d = new Date(dateStr);
                    return !isNaN(d.getTime()) ? d.toISOString().split('T')[0] : '';
                },
				
				getOsIcon(osName) {
					if (!osName) return 'fa-solid fa-desktop';
					const os = osName.toLowerCase();
					if (os.includes('server')) return 'fa-solid fa-server';
					if (os.includes('opensuse') || os.includes('linux')) return 'fa-brands fa-linux';
					if (os.includes('windows')) return 'fa-brands fa-windows';
					return 'fa-solid fa-desktop';
				},

                openModal(mode, item = null) {
                    this.haptic();
                    this.mode = mode; this.form.secret = ''; 
                    if (mode === 'edit' && item) {
                        this.form = { 
                            systemName: item.systemName, 
                            assetId: item.assetId, 
                            os: item.os, 
                            status: item.status, 
                            date: item.status === 'PENDING' ? '' : this.convertDateForInput(item.date), 
                            secret: '' 
                        };
                    } else {
                        this.form = { systemName: '', assetId: '', os: 'Windows 11 Pro', status: 'PENDING', date: '', secret: '' };
                    }
                    this.showModal = true;
                },

                openConfirmModal() { this.haptic(); this.showConfirmModal = true; },

                handleStatusChange() {
                    if (this.form.status === 'DONE') {
                        const today = new Date();
                        this.form.date = today.toISOString().split('T')[0];
                    } else { this.form.date = ''; }
                },

                async sendEmailReport() {
                    this.emailSending = true; this.haptic(); showToast("Sending...");
                    const payload = { action: 'sendReport', cycle: this.currentCycleName, totalCount: this.pcs.length, doneCount: this.doneCount, pendingCount: this.pendingCount };
                    try {
                        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                        showToast("Report Sent!"); this.showReportModal = false;
                    } catch(e) { showToast("Error", true); } 
                    finally { this.emailSending = false; }
                },

                async performAction(type) {
                    if (this.form.secret !== 'PBL2026') { vibrateDevice([50, 50, 50]); showToast("Wrong Key", true); return; }
                    this.haptic(); this.submitting = true;
                    
                    let payloadDate = this.form.date;
                    if (this.form.date && this.form.status === 'DONE') {
                        const d = new Date(this.form.date);
                        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                        payloadDate = `${d.getDate()} ${monthNames[d.getMonth()]} ${d.getFullYear()}`;
                    }
                    
                    const payload = {
                        action: 'handleVacuum', type: type === 'delete' ? 'delete' : 'save',
                        systemName: this.form.systemName, realAssetId: this.form.assetId,
                        os: this.form.os, status: this.form.status, date: payloadDate, secret: this.form.secret
                    };
                    try {
                        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                        const result = await res.json();
                        if (result.status === 'success') {
                            vibrateDevice([100, 50, 100]); this.showModal = false; showToast(type === 'delete' ? "Deleted" : "Saved");
                            await this.fetchData(true); 
                            if (this.pendingCount === 0 && this.pcs.length > 0 && type === 'save') { setTimeout(() => { this.showReportModal = true; }, 500); }
                        } else { showToast(result.message, true); }
                    } catch (e) { showToast("Network Error", true); } 
                    finally { this.submitting = false; }
                },

                get filteredList() {
                    let result = this.pcs;
                    if (this.filterStatus === 'DONE') result = result.filter(p => p.status === 'DONE');
                    else if (this.filterStatus === 'PENDING') result = result.filter(p => p.status !== 'DONE');
                    if (this.search) {
                        const s = this.search.toLowerCase();
                        result = result.filter(p => (p.systemName && p.systemName.toLowerCase().includes(s)) || (p.assetId && p.assetId.toLowerCase().includes(s)));
                    }
                    return result;
                },
                get doneCount() { return this.pcs.filter(p => p.status === 'DONE').length; },
                get pendingCount() { return this.pcs.filter(p => p.status !== 'DONE').length; },
                get percentage() { if(this.pcs.length === 0) return 0; return Math.round((this.doneCount / this.pcs.length) * 100); }
            }))
        })
    </script>
</body>
</html>
